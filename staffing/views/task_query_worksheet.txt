-- stage 2, join the data to get meaningful result
select activity.id as activity_id, activity.title as activity_title, activity.description as activity_description,
location.location_name,
location.lat,
location.lng,
(select datetime(task.start_date) from task where task.activity_id = activity.id 
    order by datetime(task.start_date) limit 1 ) as active_first_date, 
(select coalesce(sum(user_task.positions),0) from user_task 
    where task.id = user_task.task_id) as activity_filled_positions,
(select coalesce(sum(task.max_positions),1) from task 
    where task.activity_id = activity.id) as activity_max_positions,
task.id as task_id,
task.title as task_title,
task.description as task_description,
task.start_date,
task.end_date,
task.max_positions,
task.skill_list,
null as participant_list, -- just a place holder
(select coalesce(sum(user_task.positions),0) from user_task 
    where task.id = user_task.task_id and task.activity_id = activity.id) as task_filled_positions
from task
join activity on activity.id = task.activity_id
left join location on location.id = activity.location_id
where date(task.start_date) >= date('{}')
order by active_first_date, task.start_date


-- Try to get location for activity and task
select activity.id as activity_id, activity.title as activity_title, activity.description as activity_description,
act_location.id as act_loc_id,
act_location.location_name as act_loc_name,
act_location.lat as act_loc_lat,
act_location.lng as act_loc_lng,
(select datetime(task.start_date) from task where task.activity_id = activity.id 
    order by datetime(task.start_date) limit 1 ) as active_first_date, 
(select coalesce(sum(user_task.positions),0) from user_task 
    where task.id = user_task.task_id) as activity_filled_positions,
(select coalesce(sum(task.max_positions),1) from task 
    where task.activity_id = activity.id) as activity_max_positions,
(select distinct coalesce(count(task.id),1) from task 
    where task.activity_id = activity.id and task.location_id not null and task.location_id <> activity.location_id) as unique_task_locations,
task.id as task_id,
task.title as task_title,
task.description as task_description,
task.start_date,
task.end_date,
task.max_positions,
task.skill_list,
task_location.id as task_loc_id,
task_location.location_name as task_loc_name,
task_location.lat as task_loc_lat,
task_location.lng as task_loc_lng,

null as participants, -- just a place holder
(select coalesce(sum(user_task.positions),0) from user_task 
    where task.id = user_task.task_id and task.activity_id = activity.id) as task_filled_positions
from task
join activity on activity.id = task.activity_id
left join location as act_location on act_location.id = activity.location_id
left join location as task_location on task_location.id = task.location_id
where date(task.start_date) >= date('{}')
order by active_first_date, task.start_date


-- signed up initials 
select  upper(substr(user.first_name,1,1) || substr(user.last_name,1,1)) as initials 
from user_task
join user on user.id = user_task.user_id
where user_task.task_id = {}
order by user.first_name, user.last_name


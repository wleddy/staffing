-- stage 2, join the data to get meaningful result
select event.id as event_id, event.title as event_title, event.description as event_description,
location.location_name,
location.lat,
location.lng,
(select datetime(job.start_date) from job where job.event_id = event.id 
    order by datetime(job.start_date) limit 1 ) as active_first_date, 
    (select coalesce(sum(user_job.positions),0) from user_job
        where user_job.job_id in (select id from job where job.event_id = event.id)) as event_filled_positions,
(select coalesce(sum(job.max_positions),1) from job 
    where job.event_id = event.id) as event_max_positions,
job.id as job_id,
job.title as job_title,
job.description as job_description,
job.start_date,
job.end_date,
job.max_positions,
job.skill_list,
null as participant_list, -- just a place holder
(select coalesce(sum(user_job.positions),0) from user_job 
    where job.id = user_job.job_id and job.event_id = event.id) as job_filled_positions
from job
join event on event.id = job.event_id
left join location on location.id = event.location_id
where date(job.start_date) >= date('{}')
order by active_first_date, job.start_date


-- Try to get location for event and job
select event.id as event_id, event.title as event_title, event.description as event_description,
act_location.id as act_loc_id,
act_location.location_name as act_loc_name,
act_location.lat as act_loc_lat,
act_location.lng as act_loc_lng,
(select datetime(job.start_date) from job where job.event_id = event.id 
    order by datetime(job.start_date) limit 1 ) as active_first_date, 
(select coalesce(sum(user_job.positions),0) from user_job 
    where job.id = user_job.job_id) as event_filled_positions,
(select coalesce(sum(job.max_positions),1) from job 
    where job.event_id = event.id) as event_max_positions,
(select distinct coalesce(count(job.id),1) from job 
    where job.event_id = event.id and job.location_id not null and job.location_id <> event.location_id) as unique_job_locations,
job.id as job_id,
job.title as job_title,
job.description as job_description,
job.start_date,
job.end_date,
job.max_positions,
job.skill_list,
job_location.id as job_loc_id,
job_location.location_name as job_loc_name,
job_location.lat as job_loc_lat,
job_location.lng as job_loc_lng,

null as participants, -- just a place holder
(select coalesce(sum(user_job.positions),0) from user_job 
    where job.id = user_job.job_id and job.event_id = event.id) as job_filled_positions
from job
join event on event.id = job.event_id
left join location as act_location on act_location.id = event.location_id
left join location as job_location on job_location.id = job.location_id
where date(job.start_date) >= date('{}')
order by active_first_date, job.start_date


-- signed up initials 
select  upper(substr(user.first_name,1,1) || substr(user.last_name,1,1)) as initials 
from user_job
join user on user.id = user_job.user_id
where user_job.job_id = {}
order by user.first_name, user.last_name


    (select coalesce(sum(user_job.positions),0) from user_job 
        where job.id = user_job.job_id) as event_filled_positions,
    (select coalesce(sum(job.max_positions),1) from job 
        where job.event_id = event.id) as event_max_positions


select coalesce(sum(user_job.positions),0) from user_job
where user_job.job_id in (select id from job where job.event_id = 1)